---
title: "Untitled"
author: "Michael"
date: '2022-10-21'
output: html_document
editor_options: 
  chunk_output_type: inline
---



```{r}
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(ggsci)
  library(scales)
  library(emmeans)
  library(lmerTest)
  library(ggpubr)
  library(rstatix)
  library(ggsignif)
  library(cowplot)
  library(viridis)
  library(grid)
  library(gtable)
  library(MASS)
})
```


#Load Data

```{r}
#re00
re00 <- readRDS("../data/re00_raw.rds")

#re02
re02 <- readRDS("../data/re02_raw.rds")

#re03
re03 <- readRDS("../data/re03_raw.rds")

#ms2
ms2 <- readRDS("../data/ms2_raw.rds")

#ms3
ms3 <- readRDS("../data/ms3_raw.rds")
```



#Exclude images with somas that couldn't be well found by Ilastik
Re00 
-	Re00_5
Re03
-	Re03_10
-	Re03_31
MS2
-	MS2_17

```{r}
#re00
re00 <- re00[re00$blinded_numbers != "Re00_5.tif",]

#re03
re03 <- re03[!(re03$blinded_numbers %in% c("Re03_10.tif","Re03_31.tif")),]

#ms2
ms2 <- ms2[ms2$blinded_numbers != "MS2_17.tif",]
```



#Filter out all mitos that are not in the soma and have a higher intensity than 5x the standard deviation
```{r}
#re00
re00_filter <- re00[re00$Parent_SomaEx == 0,]
re00_filter_val <- mean(re00_filter$Intensity_MeanIntensity_cropRaw) + 
  (5* sd(re00_filter$Intensity_MeanIntensity_cropRaw))
neg_re00_filter_val <- mean(re00_filter$Intensity_MeanIntensity_cropRaw) - 
  (5* sd(re00_filter$Intensity_MeanIntensity_cropRaw))

re00 <- re00[(re00$Parent_SomaEx > 0) | (re00$Parent_SomaEx == 0 & re00$Intensity_MeanIntensity_cropRaw < re00_filter_val),]
max(re00[re00$Parent_SomaEx == 0,"Intensity_MeanIntensity_cropRaw"])

#re02
re02_filter <- re02[re02$Parent_SomaEx == 0,]
re02_filter_val <- mean(re02_filter$Intensity_MeanIntensity_cropRaw) + 
  (5* sd(re02_filter$Intensity_MeanIntensity_cropRaw))
neg_re02_filter_val <- mean(re02_filter$Intensity_MeanIntensity_cropRaw) - 
  (5* sd(re02_filter$Intensity_MeanIntensity_cropRaw))

re02 <- re02[(re02$Parent_SomaEx > 0) | (re02$Parent_SomaEx == 0 & re02$Intensity_MeanIntensity_cropRaw < re02_filter_val),]
max(re02[re02$Parent_SomaEx == 0,"Intensity_MeanIntensity_cropRaw"])

#re03
re03_filter <- re03[re03$Parent_SomaEx == 0,]
re03_filter_val <- mean(re03_filter$Intensity_MeanIntensity_cropRaw) + 
  (5* sd(re03_filter$Intensity_MeanIntensity_cropRaw))
neg_re03_filter_val <- mean(re03_filter$Intensity_MeanIntensity_cropRaw) - 
  (5* sd(re03_filter$Intensity_MeanIntensity_cropRaw))

re03 <- re03[(re03$Parent_SomaEx > 0) | (re03$Parent_SomaEx == 0 & re03$Intensity_MeanIntensity_cropRaw < re03_filter_val),]
max(re03[re03$Parent_SomaEx == 0,"Intensity_MeanIntensity_cropRaw"])

#ms2
ms2_filter <- ms2[ms2$Parent_SomaEx == 0,]
ms2_filter_val <- mean(ms2_filter$Intensity_MeanIntensity_cropRaw) + 
  (5* sd(ms2_filter$Intensity_MeanIntensity_cropRaw))
neg_ms2_filter_val <- mean(ms2_filter$Intensity_MeanIntensity_cropRaw) - 
  (5* sd(ms2_filter$Intensity_MeanIntensity_cropRaw))

ms2 <- ms2[(ms2$Parent_SomaEx > 0) | (ms2$Parent_SomaEx == 0 & ms2$Intensity_MeanIntensity_cropRaw < ms2_filter_val),]
max(ms2[ms2$Parent_SomaEx == 0,"Intensity_MeanIntensity_cropRaw"])

#ms3
ms3_filter <- ms3[ms3$Parent_SomaEx == 0,]
ms3_filter_val <- mean(ms3_filter$Intensity_MeanIntensity_cropRaw) + 
  (5* sd(ms3_filter$Intensity_MeanIntensity_cropRaw))
neg_ms3_filter_val <- mean(ms3_filter$Intensity_MeanIntensity_cropRaw) - 
  (5* sd(ms3_filter$Intensity_MeanIntensity_cropRaw))

ms3 <- ms3[(ms3$Parent_SomaEx > 0) | (ms3$Parent_SomaEx == 0 & ms3$Intensity_MeanIntensity_cropRaw < ms3_filter_val),]
max(ms3[ms3$Parent_SomaEx == 0,"Intensity_MeanIntensity_cropRaw"])
```


```{r}
e <- rbind(re00,re02,re03,ms2,ms3)
e$sample <- factor(e$sample,levels = c("pLNA-Ctrl","pLNA-1229","TSB"))
e$Diff <- factor(e$Diff)
```

```{r}
e <- e[e$sample != "TSB",]
e$sample <- droplevels(e$sample)
```


```{r}
replacement <- c(Re00 = "r4",Re02 = "r6",Re03 = "r7",MS2 = "r2", MS3 = "r3")
e$Diff <- replacement[as.character(e$Diff)]
e$Diff <- factor(e$Diff,levels = c("r2","r3","r4","r6","r7"))
```

```{r}
saveRDS(e,"../data/TMRE_Data.rds")
```











