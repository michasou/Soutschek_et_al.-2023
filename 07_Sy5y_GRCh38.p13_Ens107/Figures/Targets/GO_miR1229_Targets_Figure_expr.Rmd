---
title: "GO_Figure"
author: "Michael"
date: "4 3 2020"
output: html_document
---

```{r}
library(RColorBrewer)
library(ggplot2)
library(plyr)
library(data.table)
library(SummarizedExperiment)
```



#Import
```{r}
CC <- readRDS("../../longRNA_R/Target_Analysis/GO/GO_data/GO_CC_miR1229_Targets_10nM_expr_elim_005.rds")
MF <- readRDS("../../longRNA_R/Target_Analysis/GO/GO_data/GO_MF_miR1229_Targets_10nM_expr_elim_005.rds")
BP <- readRDS("../../longRNA_R/Target_Analysis/GO/GO_data/GO_BP_miR1229_Targets_10nM_expr_elim_005.rds")
```


```{r}
se <- readRDS("../../data/SE.dea.Gene.salmon.raw.rds")
dea1229 <- rowData(se)[["DEA.ind.Ctrl-MiR"]] 
dea1229$Ensembl <- sapply(strsplit(row.names(dea1229),split = "\\."),"[",1)
dea1229$Symbol <- sapply(strsplit(row.names(dea1229),split = "\\."),"[",2)

dea1229_sig_down <- dea1229[dea1229$FDR < 0.05 & dea1229$logFC < 0,"Symbol"]
dea1229_sig_up <- dea1229[dea1229$FDR < 0.05 & dea1229$logFC > 0,"Symbol"]
```



#Data preparaion

Get significant counts
```{r}
CC$up <- sapply(CC$Sig_Genes, function(x) sum(x %in% dea1229_sig_up))
CC$down <- sapply(CC$Sig_Genes, function(x) sum(x %in% dea1229_sig_down))

MF$up <- sapply(MF$Sig_Genes, function(x) sum(x %in% dea1229_sig_up))
MF$down <- sapply(MF$Sig_Genes, function(x) sum(x %in% dea1229_sig_down))

BP$up <- sapply(BP$Sig_Genes, function(x) sum(x %in% dea1229_sig_up))
BP$down <- sapply(BP$Sig_Genes, function(x) sum(x %in% dea1229_sig_down))
```

Filter
15 < x
```{r}
CC_Top <- CC[which(CC$Annotated > 15),]
BP_Top <- BP[which(BP$Annotated > 15),]
MF_Top <- MF[which(MF$Annotated > 15),]
```


```{r}
CC_Top <- CC_Top[1:15,]
BP_Top <- BP_Top[1:15,]
MF_Top <- MF_Top[1:15,]

#Create uniform label fields
CC_Top$label1 <- 1.1e-05
CC_Top$label2 <- 1.11

MF_Top$label1 <- 1.1e-05
MF_Top$label2 <- 1.11

BP_Top$label1 <- 1.1e-05
BP_Top$label2 <- 1.11
```


```{r}
CC_Top$Fisher.elim <- as.numeric(CC_Top$Fisher.elim)
CC_Top$rank <- frank(CC_Top$Fisher.elim, ties.method = "first")

MF_Top$Fisher.elim <- as.numeric(MF_Top$Fisher.elim)
MF_Top$rank <- frank(MF_Top$Fisher.elim, ties.method = "first")

BP_Top$Fisher.elim <- as.numeric(BP_Top$Fisher.elim)
BP_Top$rank <- frank(BP_Top$Fisher.elim, ties.method = "first")
```






```{r}

factor_CC <- factor(CC_Top$rank, levels = CC_Top$rank, labels = CC_Top$GO.ID)

factor_MF <- factor(MF_Top$rank, levels = MF_Top$rank, labels = MF_Top$GO.ID)

factor_BP <- factor(BP_Top$rank, levels = BP_Top$rank, labels = BP_Top$GO.ID)

```




## Figures

Define Plot components
Define Plot components
```{r}
txt <- element_text(family = "sans", size = 14, colour = "black")
txt2 <- element_text(family = "sans", size = 12, colour = "black")
tick <- element_line(linewidth = 1)
color.fill <- c("Down" = "#BC3C29","Up" = "#E18727")
```



Figrue CC
```{r}
# p <- ggplot(data = CC_Top, aes(x = as.factor(CC_Top$GO.ID))) +
#   scale_x_discrete(labels = rev(CC_Top$Term), limits = rev(levels(factor_CC)), name = "")+
#   geom_bar(aes(y = CC_Top$down,fill = "Down"), stat = "identity") +
#   scale_fill_manual(values=color.fill) +
#   geom_label(aes(label = CC_Top$label1, y = 0),colour = NA, fill = "#636363") +
#   geom_text(aes(label = CC_Top$Fisher.elim, y = 0), colour = "white") +
#   geom_label(label = CC_Top$label2, y = 17,label.size = 5, colour = NA, fill = "#636363") +
#   geom_text(aes(label = round(CC_Top$Fold_Enrichment,2), y = 17), colour = "white") +
#   scale_y_continuous(limits = c(-2.25,20), name = "Number of Genes")+ 
#   coord_flip(clip = "off", xlim = c(1,15)) +
#   annotate("label", x = 15.9, y = 0,colour = NA,label = "P.Value", fill = "#636363") +
#   annotate("text", x = 15.9, y = 0,label= "P.Value",colour = "white") +
#   annotate("label", x = 15.9, y = 17,colour = NA,label = "Enrichment", fill = "#636363") +
#   annotate("text", x = 15.9, y = 17,label= "Enrichment",colour = "white") +
#   ggtitle("DEA 10nM Top15 sign. genes with BS (FDR < 0.05, 7mer or 8mer )") +
#   theme_classic() +
#   theme(axis.title = txt, axis.text = txt,  axis.ticks = tick,
#         legend.position = c(0.9,-0.13), legend.direction = "horizontal", legend.text = txt2, legend.title = element_blank(),
#         plot.margin = unit(c(3,1,3,1),"lines"),
#         plot.title = element_text(vjust = 5))
#         
# p
# 
# ggsave("CB_CC_10nM_expr_Targets.png", width=12, height=5, units="in", dpi=300)
# ggsave("CB_CC_10nM_expr_Targets.pdf", width=12, height=5, units="in", dpi=300)
```



#### combine
```{r}
GO <- rbind(CC_Top[1:3,],BP_Top[1:3,],MF_Top[1:3,])
GO <- GO[order(GO$Fisher.elim),]
```


```{r}
GO$Fisher.elim <- as.numeric(GO$Fisher.elim)
GO$rank <- frank(GO$Fisher.elim, ties.method = "first")
```

```{r}
GO <- GO[1:9,]
GO$Fold_Enrichment <- round(GO$Fold_Enrichment,2)

#Create uniform label fields
GO$label1 <- 1.1e-05
GO$label2 <- 1.11
```

```{r}
factor_GO <- factor(GO$rank, levels = GO$rank, labels = GO$GO.ID)
```




Figure
```{r}
p <- ggplot(data = GO, aes(x = as.factor(GO$GO.ID))) +
  scale_x_discrete(labels = rev(GO$Term), limits = rev(levels(factor_GO)), name = "")+
  geom_bar(aes(y = GO$down,fill = "Down"), stat = "identity") +
  scale_fill_manual(values=color.fill) +
  geom_label(aes(label = GO$label1, y = 0),colour = NA, fill = "#636363") +
  geom_text(aes(label = GO$Fisher.elim, y = 0), colour = "white") +
  geom_label(label = GO$label2, y = 17,label.size = 5, colour = NA, fill = "#636363") +
  geom_text(aes(label = round(GO$Fold_Enrichment,2), y = 17), colour = "white") +
  scale_y_continuous(limits = c(-2.25,20), name = "Number of Genes")+ 
  coord_flip(clip = "off", xlim = c(1,9)) +
  annotate("label", x = 9.5, y = 0,colour = NA,label = "P.Value", fill = "#636363") +
  annotate("text", x = 9.5, y = 0,label= "P.Value",colour = "white") +
  annotate("label", x = 9.5, y = 17,colour = NA,label = "Enrichment", fill = "#636363") +
  annotate("text", x = 9.5, y = 17,label= "Enrichment",colour = "white") +
  ggtitle("DEA 10nM sign. genes expressed in neurons with BS (FDR < 0.05, 7mer or 8mer )\nTop3 of each GO-Category") +
  theme_classic() +
  theme(axis.title = txt, axis.text = txt,  axis.ticks = tick,
        legend.position = c(0.9,-0.13), legend.direction = "horizontal", legend.text = txt2, legend.title = element_blank(),
        plot.margin = unit(c(3,1,3,1),"lines"),
        plot.title = element_text(vjust = 5))
        
p

ggsave("../Figure_Output/Targets/GO_Combined_10nM_expr_Targets.png", width=12, height=6, units="in", dpi=300)
```










